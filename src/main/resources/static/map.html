<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport"
	content="width=device-width, initial-scale=1, shrink-to-fit=no" />
<meta name="description" content="" />
<meta name="author" content="" />
<title>Agency - Start Bootstrap Theme</title>
<!-- Favicon-->
<link rel="icon" type="image/x-icon" href="assets/favicon.ico" />
<!-- Font Awesome icons (free version)-->
<script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js"
	crossorigin="anonymous"></script>
<!-- Google fonts-->
<link href="https://fonts.googleapis.com/css?family=Montserrat:400,700"
	rel="stylesheet" type="text/css" />
<link
	href="https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700"
	rel="stylesheet" type="text/css" />
<!-- Core theme CSS (includes Bootstrap)-->
<link href="css/styles.css" rel="stylesheet" />
<!-- <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65"
        crossorigin="anonymous"
        /> -->
<link rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" />
<script src="assets/js/key.js"></script>
</head>
<body id="page-top">
	<!-- Navigation-->
	<nav class="navbar navbar-expand-lg navbar-dark fixed-top" id="mainNav">
		<div class="container">
			<a class="navbar-brand" href="/index"><img
				src="assets/img/navbar-logo.svg" alt="..." /></a>
			<button class="navbar-toggler" type="button" data-bs-toggle="collapse"
				data-bs-target="#navbarResponsive" aria-controls="navbarResponsive"
				aria-expanded="false" aria-label="Toggle navigation">
				Menu <i class="fas fa-bars ms-1"></i>
			</button>
			<div class="collapse navbar-collapse" id="navbarResponsive">
				<ul class="navbar-nav text-uppercase ms-auto py-4 py-lg-0">
					<li class="nav-item"><a class="nav-link" href="/map">Map</a></li>
					<li class="nav-item"><a class="nav-link" href="/myPage">MyPage</a></li>
					<li class="nav-item"><a class="nav-link" href="/boardMain">Board</a></li>
					<li class="nav-item"><a class="nav-link" href="/login">Login</a></li>
					<li class="nav-item"><a class="nav-link" href="/logout">Logout</a></li>
				</ul>
			</div>
		</div>
	</nav>


	<!-- Contact-->
	<section class="page-section" id="contact">
		<div class="container">
			<div class="text-center">
				<h3 class="section-subheading text-muted"></h3>
				<h2 class="section-heading text-uppercase">map</h2>
			</div>
			<div class="row">
				<div class="col">
					<div class="container pt-3">
						<div class="row">
							<div class="col-3">
								<!-- class="form-select" -->
								<select id="sidoList" class="form-select"><option
										value=''>시도</option></select>
							</div>

							<div class="col-3">

								<select id="search-content-id" class="form-select me-2">
									<option value="0" selected>관광지 유형</option>
									<option value="12">관광지</option>
									<option value="14">문화시설</option>
									<option value="15">축제공연행사</option>
									<option value="25">여행코스</option>
									<option value="28">레포츠</option>
									<option value="32">숙박</option>
									<option value="38">쇼핑</option>
									<option value="39">음식점</option>
								</select>
							</div>
							<div class="col-3">
								<input id="search-keyword" class="form-control me-2"
									type="search" placeholder="검색어" aria-label="검색어" />
							</div>
							
							<div class="col-1">
								<input class="form-check-input" type="checkbox" value="" id="flexCheckChecked" checked>
								<label class="form-check-label" for="flexCheckChecked">
								정렬
								</label>
							</div>
							
							<div class="col-2">
								<div class="d-grid gap-2">
									<button id="btnSearch" type="button" class="btn btn-primary">검색</button>
								</div>
							</div>
						</div>
					</div>
					<div class="container mt-3">
								<div class="row" id="itemList"></div>
							</div>
					<!-- kakao map start -->
					<div id="map" class="mt-3" style="width: 100%; height: 500px"></div>
					<!-- kakao map end -->
					<div class="currentLocation" onclick="currentCenter()">
					    	<img src="./img/here.png" style="width:30px; height:30px;">
					</div>
					
					<div>
						<table class="table table-striped" style="display: none">
							<thead>
								<tr>
									<th>대표이미지</th>
									<th>관광지명</th>
									<th>주소</th>
									<th>위도</th>
									<th>경도</th>
								</tr>
							</thead>
							<tbody id="trip-list"></tbody>
						</table>
					</div>
				</div>
	</section>
	<!-- Footer-->
	<footer class="footer py-4">
		<div class="container">
			<div class="row align-items-center">
				<div class="col-lg-4 text-lg-start">Copyright &copy; Your
					Website 2024</div>
				<div class="col-lg-4 my-3 my-lg-0">
					<a class="btn btn-dark btn-social mx-2" href="#!"
						aria-label="Twitter"><i class="fab fa-twitter"></i></a> <a
						class="btn btn-dark btn-social mx-2" href="#!"
						aria-label="Facebook"><i class="fab fa-facebook-f"></i></a> <a
						class="btn btn-dark btn-social mx-2" href="#!"
						aria-label="LinkedIn"><i class="fab fa-linkedin-in"></i></a>
				</div>
				<div class="col-lg-4 text-lg-end">
					<a class="link-dark text-decoration-none me-3" href="#!">Privacy
						Policy</a> <a class="link-dark text-decoration-none" href="#!">Terms
						of Use</a>
				</div>
			</div>
		</div>
	</footer>

	<!-- Bootstrap core JS-->
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
	<!-- Core theme JS-->
	<!-- <script src="js/scripts.js"></script> -->
	<!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
	<!-- * *                               SB Forms JS                               * *-->
	<!-- * * Activate your form at https://startbootstrap.com/solution/contact-forms * *-->
	<!-- * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *-->
	<script src="https://cdn.startbootstrap.com/sb-forms-latest.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
		integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
		crossorigin="anonymous"></script>
	<!-- <script src="./assets/js/main.js"></script> -->
	<script type="text/javascript"
		src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e04ca03ba54b9084470f4bcc772d2a4a&libraries=services,clusterer,drawing"></script>
	<script>
	var lat, lon;
	var locPostion;
	
    window.onload = async function(){

        //await getSidoList();

        document.querySelector("#btnSearch").onclick = getList;

        //showSpinner(false);
    }
    async function getList(){
        sidoCode = document.querySelector("#sidoList").value;
        contentId = document.querySelector("#search-content-id").value;
        word = document.querySelector("#search-keyword").value;
        chkSort = document.querySelector("#flexCheckChecked").checked;
        
/*         console.log(chkSort);
 */        // 거리순 토글 버튼 값 가져오기
        
        console.log( sidoCode + " / " + contentId );
        
        let url = `/trip/search`;
        
        let temp = {//post www urlencoded ...
	          sidoCode: sidoCode,
	          contentId: contentId,
	          word: word,
	          chkSort : chkSort,
	          curLatitude : lat,
	          curLongitude : lon
	          // 거리순 추가
    	};
        let query = new URLSearchParams(temp).toString();
        
        /* let urlParams=new URLSearchParams({//post www urlencoded ...
	          sidoCode: sidoCode,
	          contentId: contentId,
	          word: word,
	          chkSort : chkSort,
	          curLatitude : lat,
	          curLongitude : lon
	          // 거리순 추가
      	}); */

        
        
        let fetchOptions={
          method:"GET"
         /*  body: urlParams, */
          /* headers: {
        	  	"Content-Type" : "application/json"
        	  } */
        }
        //db에서 찾아서
        let response = await fetch(url+"?"+query, fetchOptions);
        let data = await response.json();
        console.log(data);
        
        //kakao로 보내고
        makeList(data);
    }
    
    /* async function getSidoList(){
        // spinner X - window.onload() 이미 적용
        let url = `/trip/sidoCode`;

        let response = await fetch( url);
        let codeList = await response.json();
        console.log( codeList);

        let listHtml = `<option value=''>시도를 선택하세요</option>`;
        codeList.forEach( el => {
            listHtml += `<option value='${el.sidoCode}'>${el.sidoName}</option>`
        })
        document.querySelector("#sidoList").innerHTML = listHtml;

    } */
    
    function makeOption(data) {
    	let areas = data.response.body.items.item;
        // console.log(areas);
        let sel = document.getElementById("search-area");
        areas.forEach((area) => {
        	let opt = document.createElement("option");
          	opt.setAttribute("value", area.code);
          	opt.appendChild(document.createTextNode(area.name));

	          sel.appendChild(opt);
		});
	}

    // 검색 버튼을 누르면..
    // 지역, 유형, 검색어 얻기.
    // 위 데이터를 가지고 공공데이터에 요청.
    // 받은 데이터를 이용하여 화면 구성.
      

    var positions; // marker 배열.
    function makeList(data) {
    	// hideMarkers();
        console.log(typeof data)
        console.log(data);
      
        document.querySelector("table").setAttribute("style", "display: ;");
        let trips = data;
        let tripList = ``;
        positions = [];
        trips.forEach((area) => {
        	tripList += `
            	<tr onclick="moveCenter(${area.latitude}, ${area.longitude});">
	              	<td><img src="${area.firstimage}" width="100px"></td>
	              	<td>${area.title}</td>
	              	<td>${area.addr1}</td>
	              	<td>${area.latitude}</td>
	              	<td>${area.longitude}</td>
            	</tr>
          		`;

          	let markerInfo = {
            title: area.title,
            latlng: new kakao.maps.LatLng(area.latitude, area.longitude),
   		};
        positions.push(markerInfo);
        });
        document.getElementById("trip-list").innerHTML = tripList;
        displayMarker();
  	}

    // 카카오지도
    var mapContainer = document.getElementById("map"), // 지도를 표시할 div
   		mapOption = {
        	center: new kakao.maps.LatLng(37.500613, 127.036431), // 지도의 중심좌표
          	level: 5, // 지도의 확대 레벨
      	};

	// 지도를 표시할 div와  지도 옵션으로  지도를 생성합니다
    var map = new kakao.maps.Map(mapContainer, mapOption);
      
   	// HTML5의 geolocation으로 사용할 수 있는지 확인합니다 
    if (navigator.geolocation) {

	    // GeoLocation을 이용해서 접속 위치를 얻어옵니다
	    navigator.geolocation.getCurrentPosition(function(position) {
              
        	lat = position.coords.latitude; // 위도
            lon = position.coords.longitude; // 경도
              
          	locPosition = new kakao.maps.LatLng(lat, lon) // 마커가 표시될 위치를 geolocation으로 얻어온 좌표로 생성합니다

            // 마커를 생성합니다
            var marker = new kakao.maps.Marker({
            	map: map, // 마커를 표시할 지도
                position: locPosition, // 마커를 표시할 위치
          	});
              
           	// 첫번째 검색 정보를 이용하여 지도 중심을 이동 시킵니다
            map.setCenter(locPosition);
   		});
          
	} else { // HTML5의 GeoLocation을 사용할 수 없을때 마커 표시 위치와 인포윈도우 내용을 설정합니다
    	alert("현 위치를 가져올 수 없습니다.");
    }
      
    function hideMarkers() {
    	setMarkers(null);    
    }
    
    function setMarkers(map) {
    	for (var i = 0; i < markers.length; i++) {
        	markers[i].setMap(map);
       	}            
   	}
    
    function displayMarker() {
    	// 마커 이미지의 이미지 주소입니다
        var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";

        for (var i = 0; i < positions.length; i++) {
        	// 마커 이미지의 이미지 크기 입니다
          	var imageSize = new kakao.maps.Size(24, 35);

          	// 마커 이미지를 생성합니다
          	var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

          	// 마커를 생성합니다
          	var marker = new kakao.maps.Marker({
            	map: map, // 마커를 표시할 지도
            	position: positions[i].latlng, // 마커를 표시할 위치
            	title: positions[i].title, // 마커의 타이틀, 마커에 마우스를 올리면 타이틀이 표시됩니다
            	image: markerImage, // 마커 이미지
          	});
		}

        // 첫번째 검색 정보를 이용하여 지도 중심을 이동 시킵니다
        map.setCenter(positions[0].latlng);
	}

    function moveCenter(lat, lng) {
    	map.setCenter(new kakao.maps.LatLng(lat, lng));
  	}
      
    function currentCenter(){
    	map.setCenter(locPosition);
  	}
    </script>
</body>
</html>
